<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <!-- Load Blockly core -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <!-- Load the default blocks -->
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <!-- Load a generator -->
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <!-- Load a message file -->
    <script src="https://unpkg.com/blockly/msg/en.js"></script>
  </head>
  <body>
    <h1>Create your script!</h1>

    <button id="button">Run it!</button>
    <button id="show_code">Show code</button>

    <!-- <div id="blocklyDiv" style="height: 480px; width: 600px;"></div> -->
    <div id="blocklyDiv" style="height: 600px;"></div>

    <script>

    const definitions = Blockly.defineBlocksWithJsonArray([
      {
        // The type is like the "class name" for your block. It is used to construct
        // new instances. E.g. in the toolbox.
        type: 'k6_test',
        colour: 160,
        // The message defines the basic text of your block, and where inputs or
        // fields will be inserted.
        message0: 'K6 Test',
        message1: 'options %1',
        args1: [
          // Each arg is associated with a %# in the message.
          // This one gets substituted for %1.
          {
            type: 'input_value',
            name: 'OPTIONS',
            check: 'options',
          }
        ],
        message2: 'requests %1',
        args2: [
          // Each arg is associated with a %# in the message.
          // This one gets substituted for %1.
          {
            type: 'input_value',
            name: 'REQUESTS',
            <!-- check: 'http_request', -->
          }
        ],
        // Adds an untyped next connection to the bottom of the block.
        nextStatement: null,
      },
      {
        type: 'options',
        colour: 222,
        output: null,
        // The message defines the basic text of your block, and where inputs or
        // fields will be inserted.
        message0: 'VUS %1',
        args0: [
          // Each arg is associated with a %# in the message.
          // This one gets substituted for %1.
          {
            type: 'field_number',
            name: 'VUS',
          }
        ],
        message1: 'duration(s) %1',
        args1: [
          {
            type: 'field_number',
            name: 'DURATION',
          }
        ],
      },
      {
        type: 'http_request',
        colour: 111,
        output: null,
        // The message defines the basic text of your block, and where inputs or
        // fields will be inserted.
        message0: 'HTTP GET %1',
        args0: [
          // Each arg is associated with a %# in the message.
          // This one gets substituted for %1.
          {
            type: 'field_input',
            name: 'REQUEST',
            text: "https://test.k6.io"
          }
        ],
        <!-- message1: 'data %1', -->
        <!-- args1: [ -->
        <!--   { -->
        <!--     type: 'field_input', -->
        <!--     name: 'DATA', -->
        <!--     text: '', -->
        <!--   } -->
        <!-- ], -->

        nextStatement: null,
      },
      {
        type: 'http_check',
        colour: 177,
        // The message defines the basic text of your block, and where inputs or
        // fields will be inserted.
        message0: 'check',
        message0: 'field %1 %3 value %2',
        args0: [
          {
            type: 'field_input',
            name: 'FIELD',
            text: "status"
          },
          {
            type: 'field_input',
            name: 'VALUE',
          },
          {
            type: 'field_dropdown',
            name: 'OPERATOR',
            options: [
                [ "==", "==" ],
                [ "!=", "!=" ],
                [ ">=", ">=" ],
                [ "<=", "<=" ],
                [ ">", ">" ],
                [ "<", "<" ],
              ]
          }
        ],

        previousStatement: null,
        nextStatement: null,
      }
    ]);

    // code generator 

    javascript.javascriptGenerator.forBlock['k6_test'] = function(block, generator) {
      const steps = block.getFieldValue('FIELD_NAME');
      const options = block.getInputTargetBlock('OPTIONS');
      const requests_block = block.getInputTargetBlock('REQUESTS');
        <!-- console.log(request_block.getChildren()); -->
        <!-- console.log(request_block.type); -->

      const vus = options.getFieldValue('VUS');
      const duration = options.getFieldValue('DURATION');


      var default_func = `
            export default function () {
            `;

        requests_list = []
        if (requests_block.type == "lists_create_with") {
            requests_list = requests_block.getChildren();

        } else {
            requests_list = [requests_block];
        }

        for (const request_block of requests_list) {
            const request = request_block.getFieldValue('REQUEST');

            var check_str = ''
            var check_block = request_block.getNextBlock()
            while (check_block) {
                const field = check_block.getFieldValue('FIELD')
                const value = check_block.getFieldValue('VALUE')
                const operator = check_block.getFieldValue('OPERATOR')

                check_str += `check(res, { '${field} ${operator} ${value}': (r) => r.${field} ${operator} ${value} });\n`

                check_block = check_block.getNextBlock();
            }

            default_func += `
                var res = http.get('${request}');
                ${check_str}
            `;
        }

        default_func += `
            sleep(1);
            }`;


      

        const script = `

            import http from 'k6/http';
            import { sleep, check } from 'k6';

            export const options = {
                vus: ${vus},
                duration: '${duration}s',
            };

            ${default_func}

        `

        return script
    }

    // workspace

    const toolbox = {
      // There are two kinds of toolboxes. The simpler one is a flyout toolbox.
      kind: 'flyoutToolbox',
      // The contents is the blocks and other items that exist in your toolbox.
      contents: [
        {
          kind: 'block',
          type: 'k6_test'
        },
        {
          kind: 'block',
          type: 'options'
        },
        {
          kind: 'block',
          type: 'http_request'
        },
        {
          kind: 'block',
          type: 'http_check'
        },
        {
          kind: 'block',
          type: 'lists_create_with'
        }
      ]
    };
        const workspace = Blockly.inject('blocklyDiv', { toolbox: toolbox });

    <!-- document.getElementById("button").addEventListener("click", function() { -->
    <!--     const script = javascript.javascriptGenerator.workspaceToCode(workspace); -->
    <!--     console.log(script) -->
    <!-- }) -->


      // access the pre-bundled global API functions
      const { invoke } = window.__TAURI__.tauri

    function open_run_window() {
      const script = javascript.javascriptGenerator.workspaceToCode(workspace);

      invoke('open_run_window', {'script': script })
        // `invoke` returns a Promise
        .then((response) => {
            console.log(response)
        })
        .catch((error) => {
            console.log(error)
        })
    }

    document.getElementById("button").addEventListener("click", function() {
        open_run_window();
    })

    document.getElementById("show_code").addEventListener("click", function() {
        const script = javascript.javascriptGenerator.workspaceToCode(workspace);
        alert(script);
    })

      const mainWindow = window.__TAURI__.window.WebviewWindow.getByLabel('main')
    mainWindow.blobby = 2
    </script>
  </body>
</html>
